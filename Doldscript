-- Doldscript - Roube um peixe (versão organizada)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer

-- Referências
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local function getHumanoid(char)
    return char and (char:FindFirstChildOfClass("Humanoid") or char:FindFirstChild("Humanoid"))
end
local HRP = Character:WaitForChild("HumanoidRootPart")
local Humanoid = getHumanoid(Character)

LocalPlayer.CharacterAdded:Connect(function(char)
    Character = char
    HRP = char:WaitForChild("HumanoidRootPart")
    Humanoid = getHumanoid(char)
end)

-- Estados
local basePos, flying = nil, false
local speedBoost, highJump, noclip = false, false, false
local loopKillEnabled, loopKillName, loopTask = false, "", nil
local freezeAll = false

-- ===== Funções =====
local function notify(lbl, text, color)
    if lbl then
        lbl.Text = text
        lbl.TextColor3 = color or Color3.fromRGB(255,255,255)
    end
end

local function findPlayerByName(name)
    if not name or name == "" then return nil end
    name = name:lower():gsub("^%s*(.-)%s*$","%1")
    for _,plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            local n = (plr.Name or ""):lower()
            local dn = (plr.DisplayName or ""):lower()
            if n == name or dn == name then
                return plr
            end
        end
    end
    return nil
end

local function killPlayerOnce(plr)
    if not plr or not plr.Character then return false end
    local hum = plr.Character:FindFirstChildOfClass("Humanoid")
    if not hum then return false end
    pcall(function() hum:TakeDamage((hum.MaxHealth or 100) * 2) end)
    pcall(function() hum.Health = 0 end)
    pcall(function() plr.Character:BreakJoints() end)
    return hum.Health <= 0
end

local function startLoopKill(name, statusLabel)
    loopKillName = name
    loopKillEnabled = true
    if loopTask and type(loopTask.cancel) == "function" then pcall(function() loopTask.cancel() end) end
    loopTask = task.spawn(function()
        while loopKillEnabled do
            local target = findPlayerByName(loopKillName)
            if target and target.Character and target.Character:FindFirstChildOfClass("Humanoid") then
                local ok = killPlayerOnce(target)
                notify(statusLabel, ok and ("Matou: "..target.Name) or ("Tentando matar: "..target.Name), ok and Color3.fromRGB(200,255,200) or Color3.fromRGB(255,200,100))
            else
                notify(statusLabel, "Alvo não encontrado", Color3.fromRGB(255,150,150))
            end
            task.wait(0.6)
        end
        notify(statusLabel, "Loop Kill desligado", Color3.fromRGB(200,200,200))
    end)
end

local function stopLoopKill()
    loopKillEnabled = false
end

-- ===== GUI =====
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
ScreenGui.Name = "DoldscriptUI"

local Frame = Instance.new("Frame", ScreenGui)
Frame.Size = UDim2.new(0, 420, 0, 420)
Frame.Position = UDim2.new(0.5,0,0.5,0)
Frame.AnchorPoint = Vector2.new(0.5,0.5)
Frame.BackgroundColor3 = Color3.fromRGB(28,28,28)
Instance.new("UICorner", Frame).CornerRadius = UDim.new(0,12)

-- Close / Open
local CloseBtn = Instance.new("TextButton", Frame)
CloseBtn.Size = UDim2.new(0,32,0,32)
CloseBtn.Position = UDim2.new(1,-38,0,6)
CloseBtn.Text = "X"
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.TextSize = 18
CloseBtn.BackgroundColor3 = Color3.fromRGB(200,40,40)
CloseBtn.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", CloseBtn).CornerRadius = UDim.new(0,6)

local OpenBtn = Instance.new("TextButton", ScreenGui)
OpenBtn.Size = UDim2.new(0,44,0,44)
OpenBtn.Position = UDim2.new(0,10,0,10)
OpenBtn.Text = "D"
OpenBtn.Font = Enum.Font.GothamBold
OpenBtn.TextSize = 22
OpenBtn.BackgroundColor3 = Color3.fromRGB(50,50,200)
OpenBtn.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", OpenBtn).CornerRadius = UDim.new(0,6)
OpenBtn.Visible = false

CloseBtn.MouseButton1Click:Connect(function()
    Frame.Visible = false
    OpenBtn.Visible = true
end)
OpenBtn.MouseButton1Click:Connect(function()
    Frame.Visible = true
    OpenBtn.Visible = false
end)

-- ===== botão D arrastável =====
local draggingOpen, dragInputOpen, mousePosOpen, framePosOpen = false
OpenBtn.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        draggingOpen = true
        mousePosOpen = input.Position
        framePosOpen = OpenBtn.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then draggingOpen = false end
        end)
    end
end)
OpenBtn.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then dragInputOpen = input end
end)
RunService.RenderStepped:Connect(function()
    if draggingOpen and dragInputOpen then
        local delta = dragInputOpen.Position - mousePosOpen
        OpenBtn.Position = UDim2.new(framePosOpen.X.Scale, framePosOpen.X.Offset + delta.X, framePosOpen.Y.Scale, framePosOpen.Y.Offset + delta.Y)
    end
end)

-- ===== Conteúdo =====
local Title = Instance.new("TextLabel", Frame)
Title.Size = UDim2.new(1,-60,0,48)
Title.Position = UDim2.new(0,12,0,6)
Title.BackgroundTransparency = 1
Title.Text = "Doldscript - Roube um peixe"
Title.TextColor3 = Color3.fromRGB(255,200,50)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 22

local function createBtn(parent, text, posY)
    local b = Instance.new("TextButton", parent)
    b.Size = UDim2.new(0.9,0,0,40)
    b.Position = UDim2.new(0.05,0,0,posY)
    b.BackgroundColor3 = Color3.fromRGB(70,70,70)
    b.Text = text
    b.Font = Enum.Font.GothamBold
    b.TextSize = 16
    b.TextColor3 = Color3.fromRGB(255,255,255)
    Instance.new("UICorner", b).CornerRadius = UDim.new(0,8)
    return b
end

-- Categorias
local MainFrame = Instance.new("Frame", Frame)
MainFrame.Size = UDim2.new(1,-24,1,-120)
MainFrame.Position = UDim2.new(0,12,0,100)
MainFrame.BackgroundTransparency = 1

local PlayersFrame = Instance.new("Frame", Frame)
PlayersFrame.Size = MainFrame.Size
PlayersFrame.Position = MainFrame.Position
PlayersFrame.BackgroundTransparency = 1
PlayersFrame.Visible = false

local TabMain = createBtn(Frame, "Principal", 60)
local TabPlayers = createBtn(Frame, "Players", 110)
TabPlayers.BackgroundColor3 = Color3.fromRGB(50,50,50)

local function switchToMain()
    MainFrame.Visible = true
    PlayersFrame.Visible = false
    TabMain.BackgroundColor3 = Color3.fromRGB(70,70,70)
    TabPlayers.BackgroundColor3 = Color3.fromRGB(50,50,50)
end
local function switchToPlayers()
    MainFrame.Visible = false
    PlayersFrame.Visible = true
    TabMain.BackgroundColor3 = Color3.fromRGB(50,50,50)
    TabPlayers.BackgroundColor3 = Color3.fromRGB(70,70,70)
end
TabMain.MouseButton1Click:Connect(switchToMain)
TabPlayers.MouseButton1Click:Connect(switchToPlayers)

-- Botões principais
local y = 0
local MarkBtn = createBtn(MainFrame, "Marcar Base", y); y += 50
local GoBtn = createBtn(MainFrame, "Voltar Base", y); y += 50
local SpeedBtn = createBtn(MainFrame, "Speed Boost", y); y += 50
local JumpBtn = createBtn(MainFrame, "High Jump", y); y += 50
local NoclipBtn = createBtn(MainFrame, "Noclip", y); y += 50

-- Players
local P_y = 10
local KillBox = Instance.new("TextBox", PlayersFrame)
KillBox.Size = UDim2.new(0.9,0,0,36)
KillBox.Position = UDim2.new(0.05,0,0,P_y)
KillBox.PlaceholderText = "Nome do jogador para Loop Kill"
KillBox.BackgroundColor3 = Color3.fromRGB(55,55,55)
KillBox.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", KillBox).CornerRadius = UDim.new(0,6)
P_y += 46

local LoopBtn = createBtn(PlayersFrame, "Ativar Loop Kill", P_y); P_y += 50
local FreezeBtn = createBtn(PlayersFrame, "Freeze All", P_y)

local StatusLabel = Instance.new("TextLabel", Frame)
StatusLabel.Size = UDim2.new(1,-24,0,24)
StatusLabel.Position = UDim2.new(0,12,1,-36)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Status: pronto"
StatusLabel.TextColor3 = Color3.fromRGB(200,200,200)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 14

-- Conexões
MarkBtn.MouseButton1Click:Connect(function()
    if HRP then basePos = HRP.Position MarkBtn.Text = "Base Marcada ✔" notify(StatusLabel, "Base marcada") end
end)
GoBtn.MouseButton1Click:Connect(function()
    if flying or not basePos then notify(StatusLabel, "Nenhuma base marcada") return end
    flying = true
    local dist = (basePos - HRP.Position).Magnitude
    local duration = math.max(0.05, dist / 250)
    pcall(function()
        local t = TweenService:Create(HRP, TweenInfo.new(duration, Enum.EasingStyle.Linear), {CFrame = CFrame.new(basePos + Vector3.new(0,3,0))})
        t:Play() t.Completed:Wait()
    end)
    flying = false
    notify(StatusLabel, "Chegou na base")
end)
SpeedBtn.MouseButton1Click:Connect(function() speedBoost = not speedBoost SpeedBtn.Text = speedBoost and "Speed ✔" or "Speed Boost" end)
JumpBtn.MouseButton1Click:Connect(function() highJump = not highJump JumpBtn.Text = highJump and "Jump ✔" or "High Jump" end)
NoclipBtn.MouseButton1Click:Connect(function() noclip = not noclip NoclipBtn.Text = noclip and "Noclip ✔" or "Noclip" end)
LoopBtn.MouseButton1Click:Connect(function()
    local name = tostring(KillBox.Text)
    if name == "" then notify(StatusLabel,"Digite um nome") return end
    if not loopKillEnabled then startLoopKill(name, StatusLabel) LoopBtn.Text = "Desativar Loop Kill"
    else stopLoopKill() LoopBtn.Text = "Ativar Loop Kill" end
end)
FreezeBtn.MouseButton1Click:Connect(function() freezeAll = not freezeAll FreezeBtn.Text = freezeAll and "Freeze All ✔" or "Freeze All" end)

-- Loop principal
RunService.RenderStepped:Connect(function()
    if Humanoid then
        Humanoid.WalkSpeed = speedBoost and 150 or 16
        Humanoid.JumpPower = highJump and 150 or 50
    end
    if noclip and Character then
        for _,p in ipairs(Character:GetDescendants()) do
            if p:IsA("BasePart") then p.CanCollide = false end
        end
    end
    for _,plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            plr.Character.HumanoidRootPart.Anchored = freezeAll
        end
    end
end)

switchToMain()
